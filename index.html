<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>KOZOU+ AR Experience</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      margin: 0; 
      padding: 0;
      width: 100%; 
      height: 100%;
      background-color: #000;
      position: fixed;
      overflow: hidden;
    }
    
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: black;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: white;
    }
    
    #ar-container {
      width: 100%;
      height: 100%;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1;
      display: none;
    }
    
    #camera-view {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 10;
      filter: brightness(0.85); /* 背景をやや暗く */
    }
    
    .scene {
      position: absolute;
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      perspective: 1500px;
      z-index: 20;
    }
    
    .carousel {
      position: absolute;
      width: 100%;
      height: 300px;
      bottom: 180px; /* キーボード表面の位置を調整 */
      transform-style: preserve-3d;
      transform: rotateX(15deg); /* やや斜め上からのアングル */
      transition: transform 0.5s ease-out;
    }
    
    .card-wrapper {
      position: absolute;
      width: 320px;
      height: 200px; /* 横型カード */
      transform-style: preserve-3d;
      transition: all 0.5s ease-out;
      transform-origin: bottom center;
      /* 中央配置はtransformで行う */
      top: 0;
      left: 0;
    }
    
    .card {
      position: absolute;
      width: 100%;
      height: 0; /* 最初は高さ0（見えない） */
      bottom: 0;
      background-image: url('./assets/1waku.png');
      background-size: cover;
      background-position: bottom center;
      filter: drop-shadow(0 0 10px rgba(0, 200, 255, 0.7));
      opacity: 0.9; /* 最初は少し透明 */
      transition: height 2s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 2s cubic-bezier(0.2, 0.8, 0.2, 1);
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 200, 255, 0.7);
    }
    
    .card-reflection {
      position: absolute;
      width: 100%;
      height: 0; /* 最初は高さ0（見えない） */
      top: 0; /* 反射なので上から始まる */
      transform: rotateX(180deg) scaleY(0.6); /* 上下反転し、少し縮める */
      background-image: url('./assets/1waku.png');
      background-size: cover;
      background-position: bottom center;
      opacity: 0.3; /* 反射は透明度高め */
      filter: blur(3px) brightness(0.7); /* ぼかして暗く */
      transition: height 2s cubic-bezier(0.2, 0.8, 0.2, 1);
      border-radius: 10px;
    }
    
    @keyframes glowPulse {
      0% {
        filter: drop-shadow(0 0 5px rgba(0, 200, 255, 0.5)) blur(0px);
      }
      50% {
        filter: drop-shadow(0 0 15px rgba(0, 200, 255, 0.8)) blur(0px);
      }
      100% {
        filter: drop-shadow(0 0 5px rgba(0, 200, 255, 0.5)) blur(0px);
      }
    }
    
    @keyframes reflectionGlow {
      0% {
        filter: blur(3px) brightness(0.7) drop-shadow(0 0 2px rgba(0, 200, 255, 0.3));
      }
      50% {
        filter: blur(3px) brightness(0.7) drop-shadow(0 0 7px rgba(0, 200, 255, 0.5));
      }
      100% {
        filter: blur(3px) brightness(0.7) drop-shadow(0 0 2px rgba(0, 200, 255, 0.3));
      }
    }
    
    @keyframes float {
      0% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-5px);
      }
      100% {
        transform: translateY(0px);
      }
    }
    
    /* スワイプ誘導インジケーター */
    .swipe-hint {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(0, 200, 255, 0.8);
      font-size: 14px;
      opacity: 0;
      transition: opacity 1s ease;
      z-index: 100;
      text-align: center;
      text-shadow: 0 0 10px rgba(0, 200, 255, 0.8);
    }
    
    .swipe-arrows {
      display: flex;
      justify-content: center;
      margin-top: 10px;
    }
    
    .swipe-arrow {
      margin: 0 20px;
      font-size: 24px;
      animation: pulse 1.5s infinite ease-in-out;
    }
    
    @keyframes pulse {
      0% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
      100% { opacity: 0.3; transform: scale(1); }
    }
    
    /* 暗いオーバーレイ */
    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at center, rgba(0,0,0,0) 30%, rgba(0,0,0,0.6) 100%);
      z-index: 15;
      pointer-events: none;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="loading-screen">
    <div style="border: 5px solid rgba(0, 200, 255, 0.1); border-top: 5px solid #00c8ff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
    <div>読み込み中...</div>
    <button id="start-button" style="margin-top: 20px; padding: 15px 30px; background-color: #00a2ff; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; box-shadow: 0 0 15px rgba(0, 200, 255, 0.5);">AR体験を開始</button>
  </div>

  <div id="ar-container">
    <video id="camera-view" autoplay playsinline></video>
    <div class="overlay"></div>
    
    <div class="scene">
      <div class="carousel">
        <!-- カードはJavaScriptで動的に生成されます -->
      </div>
    </div>
    
    <div class="swipe-hint">
      スワイプでカードを切り替え
      <div class="swipe-arrows">
        <div class="swipe-arrow">←</div>
        <div class="swipe-arrow">→</div>
      </div>
    </div>
  </div>

  <script>
    // グローバル変数
    let activeCardIndex = 0;
    // カード配置のパラメータ
    const layoutParams = {
      radius: 0, // 初期化時に設定
      theta: Math.PI / 2.0, // 弧の角度範囲（90度）
      centerX: 0, // 初期化時に設定
      centerZ: 0, // 初期化時に設定
    };
    
    // DOMの読み込み完了時の処理
    document.addEventListener("DOMContentLoaded", function() {
      console.log("DOM読み込み完了");
      
      // レイアウトパラメータを初期化
      layoutParams.radius = window.innerWidth * 1.2; // 大きめの半径
      layoutParams.centerX = window.innerWidth / 2;
      layoutParams.centerZ = layoutParams.radius * 0.5;
      
      // 開始ボタンのイベント設定
      document.getElementById('start-button').addEventListener('click', function() {
        document.getElementById('loading-screen').style.display = 'none';
        initAR();
      });
    });
    
    // ARの初期化
    function initAR() {
      console.log("AR初期化開始");
      
      // ARコンテナを表示
      document.getElementById('ar-container').style.display = 'block';
      
      // カメラを起動
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(function(stream) {
          document.getElementById('camera-view').srcObject = stream;
          
          // カード群を生成
          createCards();
          
          // カメラ起動後、カードを表示
          setTimeout(growCards, 1000);
        })
        .catch(function(err) {
          console.error("カメラエラー:", err);
          console.log("カメラは使用できませんが、デモモードで続行します");
          
          // カード群を生成
          createCards();
          
          // カメラなしでもカードを表示
          setTimeout(growCards, 1000);
        });
    }
    
    // カード群を生成
    function createCards() {
      const carousel = document.querySelector('.carousel');
      const totalCards = 5; // カードの総数
      const cardData = [
        { title: "STEP 1", content: "底の方からしっかり混ぜる！" },
        { title: "STEP 2", content: "よく混ぜる" },
        { title: "STEP 3", content: "最初の一口" },
        { title: "STEP 4", content: "追いニンニク" },
        { title: "STEP 5", content: "完食" }
      ];
      
      // 中央のカードをアクティブに設定
      activeCardIndex = Math.floor(totalCards / 2);
      
      // カードを生成
      for (let i = 0; i < totalCards; i++) {
        // カードラッパーを作成
        const cardWrapper = document.createElement('div');
        cardWrapper.className = 'card-wrapper';
        cardWrapper.id = `card-wrapper-${i}`;
        cardWrapper.dataset.index = i;
        
        // 実際のカードを作成
        const card = document.createElement('div');
        card.className = 'card';
        
        // カードの内容を設定
        card.innerHTML = `
          <div style="position: absolute; top: 20px; left: 20px; color: white; font-size: 24px; font-weight: bold; text-shadow: 0 0 5px rgba(0, 200, 255, 0.8);">${cardData[i].title}</div>
          <div style="position: absolute; top: 60px; left: 20px; color: white; font-size: 16px; width: 90%; text-shadow: 0 0 5px rgba(0, 200, 255, 0.5);">${cardData[i].content}</div>
        `;
        
        // 反射を作成
        const reflection = document.createElement('div');
        reflection.className = 'card-reflection';
        
        // カードラッパーに追加
        cardWrapper.appendChild(card);
        cardWrapper.appendChild(reflection);
        
        // カルーセルに追加
        carousel.appendChild(cardWrapper);
      }
      
      // 初期カード配置を設定
      updateCardPositions();
    }
    
    // カード配置を更新（カード個別のtransformとカルーセル全体のrotateYを調整）
    function updateCardPositions() {
      const cardWrappers = document.querySelectorAll('.card-wrapper');
      const totalCards = cardWrappers.length;
      const carousel = document.querySelector('.carousel');
      
      // カルーセル全体の回転角度を計算（中央のカードが正面を向くように）
      const carouselRotation = -activeCardIndex * (layoutParams.theta / (totalCards - 1));
      carousel.style.transform = `rotateX(15deg) rotateY(${carouselRotation}rad)`;
      
      // 各カードの位置を更新
      cardWrappers.forEach((wrapper, i) => {
        // カードの角度位置を計算
        const angle = (i / (totalCards - 1) - 0.5) * layoutParams.theta;
        
        // 角度に基づく位置を計算
        const x = Math.sin(angle) * layoutParams.radius;
        const z = -Math.cos(angle) * layoutParams.radius;
        
        // 中心からの距離に基づくスケールと不透明度
        const distanceFromCenter = Math.abs(i - activeCardIndex);
        const maxDistance = Math.floor(totalCards / 2);
        const scale = 1 - 0.2 * (distanceFromCenter / maxDistance);
        const opacity = 1 - 0.4 * (distanceFromCenter / maxDistance);
        
        // カードの3D配置を設定（中央を基準に）
        wrapper.style.transform = `translateX(${x}px) translateZ(${z}px) rotateY(${angle}rad) scale(${scale})`;
        wrapper.style.opacity = opacity;
        
        // Z-インデックスの調整（中央が最前面）
        wrapper.style.zIndex = 10 - distanceFromCenter;
      });
    }
    
    // ドラッグ中の一時的なオフセットを適用した位置更新
    function updateCardPositionsWithOffset(offset) {
      const cardWrappers = document.querySelectorAll('.card-wrapper');
      const totalCards = cardWrappers.length;
      const carousel = document.querySelector('.carousel');
      
      // カルーセル全体の回転角度を計算（オフセット込み）
      const tempActiveIndex = activeCardIndex - offset;
      const carouselRotation = -tempActiveIndex * (layoutParams.theta / (totalCards - 1));
      carousel.style.transform = `rotateX(15deg) rotateY(${carouselRotation}rad)`;
      
      // 各カードの位置を更新
      cardWrappers.forEach((wrapper, i) => {
        // カードの角度位置を計算（変更なし）
        const angle = (i / (totalCards - 1) - 0.5) * layoutParams.theta;
        
        // 角度に基づく位置を計算
        const x = Math.sin(angle) * layoutParams.radius;
        const z = -Math.cos(angle) * layoutParams.radius;
        
        // 中心からの距離に基づくスケールと不透明度（オフセット込み）
        const distanceFromCenter = Math.abs(i - tempActiveIndex);
        const maxDistance = Math.floor(totalCards / 2);
        const scale = 1 - 0.2 * (distanceFromCenter / maxDistance);
        const opacity = 1 - 0.4 * (distanceFromCenter / maxDistance);
        
        // カードの3D配置を設定（中央を基準に）
        wrapper.style.transform = `translateX(${x}px) translateZ(${z}px) rotateY(${angle}rad) scale(${scale})`;
        wrapper.style.opacity = opacity;
        
        // Z-インデックスの調整（中央が最前面）
        wrapper.style.zIndex = 10 - distanceFromCenter;
      });
    }
    
    // カードを成長させる
    function growCards() {
      const cards = document.querySelectorAll('.card');
      const reflections = document.querySelectorAll('.card-reflection');
      const cardWrappers = document.querySelectorAll('.card-wrapper');
      
      // 中央から順に生えてくるように順番を設定
      const growOrder = []; 
      const midIndex = Math.floor(cards.length / 2);
      
      // 中央から両端への順番を作成
      for (let i = 0; i <= midIndex; i++) {
        growOrder.push(midIndex - i); // 中央から左
        if (midIndex + i < cards.length && midIndex + i !== midIndex) {
          growOrder.push(midIndex + i); // 中央から右
        }
      }
      
      // 一つずつ成長させる
      let delay = 0;
      growOrder.forEach((index, orderIndex) => {
        setTimeout(() => {
          // 最初にカードの根元だけが見える（高さ10pxくらい）
          cards[index].style.height = '10px';
          reflections[index].style.height = '6px';
          
          // 少し待って、徐々に伸びていくアニメーション
          setTimeout(() => {
            // カードが伸びる
            cards[index].style.height = '200px'; // 横型カード
            cards[index].style.opacity = '1'; // 完全に不透明になる
            
            // 反射も同時に伸びる
            reflections[index].style.height = '120px'; // 反射はカードよりやや短め
            
            // 伸び終わった後の処理
            setTimeout(() => {
              // グロー効果を適用
              cards[index].style.animation = 'glowPulse 3s infinite';
              reflections[index].style.animation = 'reflectionGlow 3s infinite';
              
              // わずかに浮遊するアニメーション
              // 注意: これはカードの位置制御と干渉しないCSS animationのみを適用
              // cardWrappers[index].classList.add('floating');  // CSSクラスで制御する方法もある
              cardWrappers[index].style.animation = 'float 4s ease-in-out infinite';
              
              // 最後のカードが成長したらスワイプヒントを表示
              if (orderIndex === growOrder.length - 1) {
                showSwipeHint();
                // 成長アニメーション完了後にスワイプ機能を有効化
                setupSwipeEvents();
              }
            }, 2000);
          }, 500);
        }, delay);
        
        delay += 300; // カード間の成長遅延
      });
    }
    
    // スワイプヒントを表示
    function showSwipeHint() {
      const swipeHint = document.querySelector('.swipe-hint');
      swipeHint.style.opacity = '1';
      
      // 10秒後に非表示
      setTimeout(() => {
        swipeHint.style.opacity = '0';
      }, 10000);
    }
    
    // スワイプイベントのセットアップ
    function setupSwipeEvents() {
      let startX = 0;
      let currentX = 0;
      let isSwiping = false;
      
      // タッチイベント
      document.addEventListener('touchstart', function(e) {
        startX = e.touches[0].clientX;
        currentX = startX;
        isSwiping = true;
      });
      
      document.addEventListener('touchmove', function(e) {
        if (!isSwiping) return;
        currentX = e.touches[0].clientX;
        
        // ドラッグ中のリアルタイムなカード移動（滑らかさ向上）
        if (Math.abs(currentX - startX) > 5) {
          // 一時的なオフセットを計算（スワイプ距離からオフセット値を生成）
          const dragDistance = currentX - startX;
          const offsetRange = window.innerWidth / 5; // 感度調整
          const tempOffset = dragDistance / offsetRange; // -1.0〜1.0の範囲に正規化
          
          // オフセット込みでカード位置を更新
          updateCardPositionsWithOffset(tempOffset);
        }
      });
      
      document.addEventListener('touchend', function(e) {
        if (!isSwiping) return;
        const diffX = currentX - startX;
        handleSwipe(diffX);
        isSwiping = false;
      });
      
      // マウスイベント
      document.addEventListener('mousedown', function(e) {
        startX = e.clientX;
        currentX = startX;
        isSwiping = true;
      });
      
      document.addEventListener('mousemove', function(e) {
        if (!isSwiping) return;
        currentX = e.clientX;
        
        // ドラッグ中のリアルタイムなカード移動（滑らかさ向上）
        if (Math.abs(currentX - startX) > 5) {
          // 一時的なオフセットを計算（スワイプ距離からオフセット値を生成）
          const dragDistance = currentX - startX;
          const offsetRange = window.innerWidth / 5; // 感度調整
          const tempOffset = dragDistance / offsetRange; // -1.0〜1.0の範囲に正規化
          
          // オフセット込みでカード位置を更新
          updateCardPositionsWithOffset(tempOffset);
        }
      });
      
      document.addEventListener('mouseup', function(e) {
        if (!isSwiping) return;
        const diffX = currentX - startX;
        handleSwipe(diffX);
        isSwiping = false;
      });
      
      // スワイプ処理
      function handleSwipe(diffX) {
        const threshold = 50; // スワイプと判定する最小の距離
        const cardWrappers = document.querySelectorAll('.card-wrapper');
        const maxIndex = cardWrappers.length - 1;
        
        if (diffX > threshold) {
          // 右スワイプ（前のカード）- 無限ループ対応
          activeCardIndex = (activeCardIndex > 0) ? activeCardIndex - 1 : maxIndex;
          updateCardPositions();
        } else if (diffX < -threshold) {
          // 左スワイプ（次のカード）- 無限ループ対応
          activeCardIndex = (activeCardIndex < maxIndex) ? activeCardIndex + 1 : 0;
          updateCardPositions();
        } else {
          // スワイプしきれなかった場合は元の位置に戻す
          updateCardPositions();
        }
      }
    }
  </script>
</body>
</html>