<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>KOZOU+ AR Experience</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      margin: 0; 
      padding: 0;
      width: 100%; 
      height: 100%;
      background-color: #000;
      position: fixed;
      overflow: hidden;
    }
    
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: black;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: white;
    }
    
    #ar-container {
      width: 100%;
      height: 100%;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1;
      display: none;
    }
    
    #camera-view {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 10;
      filter: brightness(0.85); /* 背景をやや暗く */
    }
    
    .scene {
      position: absolute;
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      perspective: 1500px;
      z-index: 20;
    }
    
    .carousel {
      position: absolute;
      width: 100%;
      height: 300px;
      bottom: 180px; /* キーボード表面の位置を調整 */
      transform-style: preserve-3d;
      transform: rotateX(15deg); /* やや斜め上からのアングル */
    }
    
    .card-wrapper {
      position: absolute;
      width: 320px;
      height: 200px; /* 横型カード */
      transform-style: preserve-3d;
      transition: transform 0.5s ease-out, opacity 0.5s ease-out;
      transform-origin: center center;
      /* 位置はtransformで動的に設定 */
      top: 0;
      left: calc(50% - 160px); /* 画面中央に配置 */
    }
    
    .card {
      position: absolute;
      width: 100%;
      height: 0; /* 最初は高さ0（見えない） */
      bottom: 0;
      background-image: url('./assets/1waku.png');
      background-size: cover;
      background-position: bottom center;
      filter: drop-shadow(0 0 10px rgba(0, 200, 255, 0.7));
      opacity: 0.9; /* 最初は少し透明 */
      transition: height 2s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 2s cubic-bezier(0.2, 0.8, 0.2, 1);
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 200, 255, 0.7);
    }
    
    .card-reflection {
      position: absolute;
      width: 100%;
      height: 0; /* 最初は高さ0（見えない） */
      top: 0; /* 反射なので上から始まる */
      transform: rotateX(180deg) scaleY(0.6); /* 上下反転し、少し縮める */
      background-image: url('./assets/1waku.png');
      background-size: cover;
      background-position: bottom center;
      opacity: 0.3; /* 反射は透明度高め */
      filter: blur(3px) brightness(0.7); /* ぼかして暗く */
      transition: height 2s cubic-bezier(0.2, 0.8, 0.2, 1);
      border-radius: 10px;
    }
    
    @keyframes glowPulse {
      0% {
        filter: drop-shadow(0 0 5px rgba(0, 200, 255, 0.5)) blur(0px);
      }
      50% {
        filter: drop-shadow(0 0 15px rgba(0, 200, 255, 0.8)) blur(0px);
      }
      100% {
        filter: drop-shadow(0 0 5px rgba(0, 200, 255, 0.5)) blur(0px);
      }
    }
    
    @keyframes reflectionGlow {
      0% {
        filter: blur(3px) brightness(0.7) drop-shadow(0 0 2px rgba(0, 200, 255, 0.3));
      }
      50% {
        filter: blur(3px) brightness(0.7) drop-shadow(0 0 7px rgba(0, 200, 255, 0.5));
      }
      100% {
        filter: blur(3px) brightness(0.7) drop-shadow(0 0 2px rgba(0, 200, 255, 0.3));
      }
    }
    
    @keyframes float {
      0% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-5px);
      }
      100% {
        transform: translateY(0px);
      }
    }
    
    /* 浮遊アニメーション用のクラス */
    .floating {
      animation: float 4s ease-in-out infinite;
    }
    
    /* スワイプ誘導インジケーター */
    .swipe-hint {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(0, 200, 255, 0.8);
      font-size: 14px;
      opacity: 0;
      transition: opacity 1s ease;
      z-index: 100;
      text-align: center;
      text-shadow: 0 0 10px rgba(0, 200, 255, 0.8);
    }
    
    .swipe-arrows {
      display: flex;
      justify-content: center;
      margin-top: 10px;
    }
    
    .swipe-arrow {
      margin: 0 20px;
      font-size: 24px;
      animation: pulse 1.5s infinite ease-in-out;
    }
    
    @keyframes pulse {
      0% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
      100% { opacity: 0.3; transform: scale(1); }
    }
    
    /* 暗いオーバーレイ */
    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at center, rgba(0,0,0,0) 30%, rgba(0,0,0,0.6) 100%);
      z-index: 15;
      pointer-events: none;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="loading-screen">
    <div style="border: 5px solid rgba(0, 200, 255, 0.1); border-top: 5px solid #00c8ff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
    <div>読み込み中...</div>
    <button id="start-button" style="margin-top: 20px; padding: 15px 30px; background-color: #00a2ff; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; box-shadow: 0 0 15px rgba(0, 200, 255, 0.5);">AR体験を開始</button>
  </div>

  <div id="ar-container">
    <video id="camera-view" autoplay playsinline></video>
    <div class="overlay"></div>
    
    <div class="scene">
      <div class="carousel">
        <!-- カードはJavaScriptで動的に生成されます -->
      </div>
    </div>
    
    <div class="swipe-hint">
      スワイプでカードを切り替え
      <div class="swipe-arrows">
        <div class="swipe-arrow">←</div>
        <div class="swipe-arrow">→</div>
      </div>
    </div>
  </div>

  <script>
    // グローバル変数
    let activeCardIndex = 0;
    let isSwipeEnabled = false; // スワイプ有効フラグ（出現後に有効化）
    
    // レイアウトパラメータ（共通設定）
    const layoutConfig = {
      radius: window.innerWidth * 1.5, // より大きな半径で弧を広げる
      theta: Math.PI * 0.6, // 約108度の弧
      centerZ: -300, // Z軸オフセット（手前に引き出す）
      cardWidth: 320, // カード幅
      cardSpacing: 1.5, // カード間の間隔係数
      maxScale: 1.0, // 中央カードのスケール
      minScale: 0.7, // 端のカードのスケール
      maxOpacity: 1.0, // 中央カードの不透明度
      minOpacity: 0.6 // 端のカードの不透明度
    };
    
    // DOMの読み込み完了時の処理
    document.addEventListener("DOMContentLoaded", function() {
      console.log("DOM読み込み完了");
      
      // 開始ボタンのイベント設定
      document.getElementById('start-button').addEventListener('click', function() {
        document.getElementById('loading-screen').style.display = 'none';
        initAR();
      });
    });
    
    // ARの初期化
    function initAR() {
      console.log("AR初期化開始");
      
      // ARコンテナを表示
      document.getElementById('ar-container').style.display = 'block';
      
      // カメラを起動
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(function(stream) {
          document.getElementById('camera-view').srcObject = stream;
          
          // カード群を生成
          createCards();
          
          // カメラ起動後、カードを表示
          setTimeout(growCards, 1000);
        })
        .catch(function(err) {
          console.error("カメラエラー:", err);
          console.log("カメラは使用できませんが、デモモードで続行します");
          
          // カード群を生成
          createCards();
          
          // カメラなしでもカードを表示
          setTimeout(growCards, 1000);
        });
    }
    
    // カード群を生成
    function createCards() {
      const carousel = document.querySelector('.carousel');
      const totalCards = 5; // カードの総数
      const cardData = [
        { title: "STEP 1", content: "底の方からしっかり混ぜる！" },
        { title: "STEP 2", content: "よく混ぜる" },
        { title: "STEP 3", content: "最初の一口" },
        { title: "STEP 4", content: "追いニンニク" },
        { title: "STEP 5", content: "完食" }
      ];
      
      // 中央のカードをアクティブに設定
      activeCardIndex = Math.floor(totalCards / 2);
      
      // カードを生成
      for (let i = 0; i < totalCards; i++) {
        // カードラッパーを作成
        const cardWrapper = document.createElement('div');
        cardWrapper.className = 'card-wrapper';
        cardWrapper.id = `card-wrapper-${i}`;
        cardWrapper.dataset.index = i;
        
        // 実際のカードを作成
        const card = document.createElement('div');
        card.className = 'card';
        
        // カードの内容を設定
        card.innerHTML = `
          <div style="position: absolute; top: 20px; left: 20px; color: white; font-size: 24px; font-weight: bold; text-shadow: 0 0 5px rgba(0, 200, 255, 0.8);">${cardData[i].title}</div>
          <div style="position: absolute; top: 60px; left: 20px; color: white; font-size: 16px; width: 90%; text-shadow: 0 0 5px rgba(0, 200, 255, 0.5);">${cardData[i].content}</div>
        `;
        
        // 反射を作成
        const reflection = document.createElement('div');
        reflection.className = 'card-reflection';
        
        // カードラッパーに追加
        cardWrapper.appendChild(card);
        cardWrapper.appendChild(reflection);
        
        // カルーセルに追加
        carousel.appendChild(cardWrapper);
      }
      
      // 初期位置を適用
      applyCardPositions(0); // オフセットなし
    }
    
    // カード位置を適用（activeIndexとオフセットに基づいて）
    function applyCardPositions(offset = 0) {
      const cardWrappers = document.querySelectorAll('.card-wrapper');
      const totalCards = cardWrappers.length;
      
      // 各カードの位置を更新
      cardWrappers.forEach((wrapper, i) => {
        // 実際のインデックス位置を計算（アクティブインデックスとオフセットを考慮）
        // オフセットは -1.0 〜 1.0 の小数値
        const relativeIndex = i - activeCardIndex - offset;
        
        // 相対位置を -2.0 〜 2.0 の範囲に正規化（5枚カードの場合）
        let normalizedIndex = relativeIndex;
        
        // 無限ループのため、端から端へのワープを処理
        if (normalizedIndex < -Math.floor(totalCards / 2) - 0.5) {
          normalizedIndex += totalCards;
        } else if (normalizedIndex > Math.floor(totalCards / 2) + 0.5) {
          normalizedIndex -= totalCards;
        }
        
        // 角度を計算（中央が0、左右に広がる）
        // 正規化された位置を -2.0 〜 2.0 の範囲から、角度範囲 -theta/2 〜 theta/2 にマッピング
        const maxPosition = Math.floor(totalCards / 2);
        const angle = (normalizedIndex / maxPosition) * (layoutConfig.theta / 2);
        
        // 位置を計算（円弧上の座標）
        const x = Math.sin(angle) * layoutConfig.radius;
        // Z座標は円弧の一部を形成、中央が最も手前に
        const z = layoutConfig.centerZ + Math.cos(angle) * layoutConfig.radius - layoutConfig.radius;
        
        // スケールと不透明度を計算（中央ほど大きく明るく）
        const distanceRatio = Math.abs(normalizedIndex) / maxPosition;
        const scale = layoutConfig.maxScale - (layoutConfig.maxScale - layoutConfig.minScale) * distanceRatio;
        const opacity = layoutConfig.maxOpacity - (layoutConfig.maxOpacity - layoutConfig.minOpacity) * distanceRatio;
        
        // 3D配置を設定
        wrapper.style.transform = `translateX(${x}px) translateZ(${z}px) rotateY(${angle}rad) scale(${scale})`;
        wrapper.style.opacity = opacity;
        
        // Z-インデックスの調整（中央が最前面）
        wrapper.style.zIndex = 10 - Math.abs(Math.round(normalizedIndex * 2));
      });
    }
    
    // カードを成長させる
    function growCards() {
      const cards = document.querySelectorAll('.card');
      const reflections = document.querySelectorAll('.card-reflection');
      const cardWrappers = document.querySelectorAll('.card-wrapper');
      
      // 中央から順に生えてくるように順番を設定
      const growOrder = []; 
      const midIndex = Math.floor(cards.length / 2);
      
      // 中央から両端への順番を作成
      for (let i = 0; i <= midIndex; i++) {
        growOrder.push(midIndex - i); // 中央から左
        if (midIndex + i < cards.length && midIndex + i !== midIndex) {
          growOrder.push(midIndex + i); // 中央から右
        }
      }
      
      // 一つずつ成長させる
      let delay = 0;
      growOrder.forEach((index, orderIndex) => {
        setTimeout(() => {
          // 最初にカードの根元だけが見える（高さ10pxくらい）
          cards[index].style.height = '10px';
          reflections[index].style.height = '6px';
          
          // 少し待って、徐々に伸びていくアニメーション
          setTimeout(() => {
            // カードが伸びる
            cards[index].style.height = '200px'; // 横型カード
            cards[index].style.opacity = '1'; // 完全に不透明になる
            
            // 反射も同時に伸びる
            reflections[index].style.height = '120px'; // 反射はカードよりやや短め
            
            // 伸び終わった後の処理
            setTimeout(() => {
              // グロー効果を適用
              cards[index].style.animation = 'glowPulse 3s infinite';
              reflections[index].style.animation = 'reflectionGlow 3s infinite';
              
              // わずかに浮遊するアニメーション
              cardWrappers[index].classList.add('floating');
              
              // 最後のカードが成長したらスワイプヒントを表示
              if (orderIndex === growOrder.length - 1) {
                showSwipeHint();
                // 成長アニメーション完了後にスワイプ機能を有効化
                isSwipeEnabled = true;
                setupSwipeEvents();
              }
            }, 2000);
          }, 500);
        }, delay);
        
        delay += 300; // カード間の成長遅延
      });
    }
    
    // スワイプヒントを表示
    function showSwipeHint() {
      const swipeHint = document.querySelector('.swipe-hint');
      swipeHint.style.opacity = '1';
      
      // 10秒後に非表示
      setTimeout(() => {
        swipeHint.style.opacity = '0';
      }, 10000);
    }
    
    // スワイプイベントのセットアップ
    function setupSwipeEvents() {
      let startX = 0;
      let currentX = 0;
      let isSwiping = false;
      
      // タッチイベント
      document.addEventListener('touchstart', function(e) {
        if (!isSwipeEnabled) return; // 出現アニメーション完了前はスワイプ無効
        
        startX = e.touches[0].clientX;
        currentX = startX;
        isSwiping = true;
      });
      
      document.addEventListener('touchmove', function(e) {
        if (!isSwiping || !isSwipeEnabled) return;
        
        currentX = e.touches[0].clientX;
        
        // ドラッグ中のリアルタイムなカード移動
        const dragDistance = currentX - startX;
        const dragRatio = dragDistance / (layoutConfig.cardWidth * layoutConfig.cardSpacing); // ドラッグ量を正規化
        
        // ドラッグ中はオフセット付きで位置更新
        applyCardPositions(dragRatio);
      });
      
      document.addEventListener('touchend', function(e) {
        if (!isSwiping || !isSwipeEnabled) return;
        
        const diffX = currentX - startX;
        handleSwipe(diffX);
        isSwiping = false;
      });
      
      // マウスイベント
      document.addEventListener('mousedown', function(e) {
        if (!isSwipeEnabled) return; // 出現アニメーション完了前はスワイプ無効
        
        startX = e.clientX;
        currentX = startX;
        isSwiping = true;
      });
      
      document.addEventListener('mousemove', function(e) {
        if (!isSwiping || !isSwipeEnabled) return;
        
        currentX = e.clientX;
        
        // ドラッグ中のリアルタイムなカード移動
        const dragDistance = currentX - startX;
        const dragRatio = dragDistance / (layoutConfig.cardWidth * layoutConfig.cardSpacing); // ドラッグ量を正規化
        
        // ドラッグ中はオフセット付きで位置更新
        applyCardPositions(dragRatio);
      });
      
      document.addEventListener('mouseup', function(e) {
        if (!isSwiping || !isSwipeEnabled) return;
        
        const diffX = currentX - startX;
        handleSwipe(diffX);
        isSwiping = false;
      });
      
      // スワイプ処理
      function handleSwipe(diffX) {
        const threshold = 50; // スワイプと判定する最小の距離
        const cardWrappers = document.querySelectorAll('.card-wrapper');
        const maxIndex = cardWrappers.length - 1;
        
        if (diffX > threshold) {
          // 右スワイプ（前のカード）- 無限ループ対応
          activeCardIndex = (activeCardIndex > 0) ? activeCardIndex - 1 : maxIndex;
          applyCardPositions(0); // オフセットなし
        } else if (diffX < -threshold) {
          // 左スワイプ（次のカード）- 無限ループ対応
          activeCardIndex = (activeCardIndex < maxIndex) ? activeCardIndex + 1 : 0;
          applyCardPositions(0); // オフセットなし
        } else {
          // スワイプしきれなかった場合は元の位置に戻す
          applyCardPositions(0); // オフセットなし
        }
      }
    }
  </script>
</body>
</html>