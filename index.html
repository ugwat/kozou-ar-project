<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>KOZOU+ AR Experience</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { width: 100%; height: 100%; background: #000; overflow: hidden; position: fixed; }
  #loading-screen { 
    position: fixed; top:0; left:0; width:100%; height:100%; background:black; 
    display:flex; flex-direction:column; justify-content:center; align-items:center; 
    z-index:1000; color:white; 
  }
  #ar-container { width: 100%; height: 100%; position: fixed; top: 0; left: 0; z-index: 1; display: none; }
  #camera-view { position: absolute; width: 100%; height: 100%; object-fit: cover; z-index: 10; background: #000; }
  .scene { 
    position: absolute; 
    width: 100%; 
    height: 100%; 
    perspective: 1200px; 
    z-index: 20;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .carousel {
    position: absolute; 
    width: 100%; 
    height: 100%; 
    transform: rotateX(0deg) translateY(-40px); 
  }
  .card-wrapper {
    position: absolute;
    width: 336px;
    height: 491px;
    left: 50%;
    top: 50%;
    margin-left: -168px;
    margin-top: -245.5px;
    transition: transform 0.5s ease-out, opacity 0.5s ease-out;
    perspective: 800px;
  }
  .card {
    position: absolute;
    width: 100%;
    height: 10px;
    bottom: 0;
    background-repeat: no-repeat;
    background-position: center bottom;
    background-size: contain;
    border-radius: 12px;
    opacity: 0.8;
    filter: drop-shadow(0 0 10px rgba(0,255,255,0.5));
    transition: height 2.0s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 2.0s, filter 0.5s;
    transform-origin: bottom center;
  }
  .card-wrapper.center .card {
    filter: drop-shadow(0 0 20px rgba(0,255,255,0.8));
  }
  .center .card::after {
    content: '';
    position: absolute;
    left: 0;
    height: 2px;
    width: 100%;
    background-color: rgba(0,255,255,0.5);
    animation: scanline 2s linear infinite;
    pointer-events: none;
  }
  @keyframes scanline {
    0% { top: 0; }
    100% { top: 100%; }
  }
  .overlay { 
    position: absolute; top:0; left:0; width:100%; height:100%; 
    background: radial-gradient(ellipse at center, rgba(0,0,0,0) 30%, rgba(0,0,0,0.6) 100%); 
    z-index:15; pointer-events:none;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  #card-counter {
    position: fixed;
    top: 10px;
    left: 10px;
    color: white;
    background: rgba(0,0,0,0.5);
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 14px;
    z-index: 1000;
  }
</style>
</head>

<body>
<div id="loading-screen">
  <div style="border:5px solid rgba(0,200,255,0.1); border-top:5px solid #00c8ff; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; margin-bottom:20px;"></div>
  <div>読み込み中...</div>
  <button id="start-button" style="margin-top:20px; padding:15px 30px; background:#00a2ff; color:white; border:none; border-radius:5px; font-size:18px; cursor:pointer;">AR体験を開始</button>
</div>

<div id="ar-container">
  <div class="overlay"></div>
  <div class="scene">
    <div class="carousel"></div>
  </div>
  <div id="card-counter">カード数: 0 / 現在のインデックス: 0</div>
</div>

<script>
// エラーハンドリングのポリフィル - クラッシュ防止用
(function() {
  window.onerror = function(msg, url, line, col, error) {
    console.warn('エラーが発生しましたが、実行は続行します:', msg);
    return true; // エラーイベントをキャプチャして、アプリのクラッシュを防止
  };
  
  window.addEventListener('unhandledrejection', function(event) {
    console.warn('未処理のPromise rejection:', event.reason);
    event.preventDefault();
  });
})();

// グローバル変数 - 最小限に保つ
let activeCardIndex = 0;
let isSwipeEnabled = false;
let startX = 0;
let currentX = 0;
let isSwiping = false;
let animationFrame = null;

// カード画像の設定
const cardImages = [
  './assets/1waku.png',
  './assets/c2.png',
  './assets/c3.png',
  './assets/c4.png',
  './assets/1waku.png'
];

// 設定
const config = {
  cardSpacing: 300,
  swipeSensitivity: 200,
  cardRotation: 30,
  centerZ: -400,
  cardCount: 5
};

// 初期化処理
document.addEventListener("DOMContentLoaded", function() {
  // ShowOneChildエラー対策
  if (window.ShowOneChild === undefined) {
    window.ShowOneChild = {};
  }

  // スタートボタンのイベントリスナー
  document.getElementById('start-button').addEventListener('click', startExperience);
});

// AR体験の開始
function startExperience() {
  document.getElementById('loading-screen').style.display = 'none';
  document.getElementById('ar-container').style.display = 'block';
  
  // カメラ処理は省略し、直接カードを表示
  setTimeout(createCards, 100);
}

// カード生成処理
function createCards() {
  try {
    const carousel = document.querySelector('.carousel');
    carousel.innerHTML = '';
    
    // カードの描画処理は事前画像読み込みを行う
    preloadImages(cardImages, function() {
      // 画像の読み込み後にカードを作成
      for (let i = 0; i < config.cardCount; i++) {
        const wrapper = document.createElement('div');
        wrapper.className = 'card-wrapper';
        wrapper.dataset.index = i;
        
        const card = document.createElement('div');
        card.className = 'card';
        card.style.backgroundImage = `url(${cardImages[i] || './assets/1waku.png'})`;
        
        wrapper.appendChild(card);
        carousel.appendChild(wrapper);
      }
      
      // カウンター更新
      updateCardCounter();
      
      // 初期配置設定
      updateCardPositions();
      
      // スワイプイベント設定
      setupSwipeEvents();
      
      // 画面サイズ調整
      adjustForScreenSize();
      
      // カード成長アニメーション開始
      setTimeout(growCards, 300);
    });
  } catch (err) {
    console.warn('カード作成エラー:', err);
    // エラー発生時のフォールバック処理
    fallbackCardCreation();
  }
}

// 画像の事前読み込み
function preloadImages(sources, callback) {
  let loadedCounter = 0;
  const toLoad = sources.length;
  
  // 画像が1つもない場合や配列でない場合は即座にコールバック
  if (!sources || !sources.length) {
    callback();
    return;
  }
  
  // 各画像を読み込み
  sources.forEach(function(src) {
    const img = new Image();
    img.onload = img.onerror = function() {
      loadedCounter++;
      if (loadedCounter >= toLoad) {
        callback();
      }
    };
    img.src = src;
  });
}

// エラー時のフォールバック処理
function fallbackCardCreation() {
  const carousel = document.querySelector('.carousel');
  carousel.innerHTML = ''; // 一旦クリア
  
  // 非常にシンプルな単一カードのみ表示
  const wrapper = document.createElement('div');
  wrapper.className = 'card-wrapper center';
  wrapper.style.position = 'absolute';
  wrapper.style.width = '336px';
  wrapper.style.height = '491px';
  wrapper.style.left = '50%';
  wrapper.style.top = '50%';
  wrapper.style.marginLeft = '-168px';
  wrapper.style.marginTop = '-245.5px';
  
  const card = document.createElement('div');
  card.className = 'card';
  card.style.width = '100%';
  card.style.height = '10px';
  card.style.bottom = '0';
  card.style.position = 'absolute';
  card.style.backgroundColor = '#00a2ff';
  card.style.borderRadius = '12px';
  
  wrapper.appendChild(card);
  carousel.appendChild(wrapper);
  
  // 最小限のアニメーション
  setTimeout(function() {
    card.style.height = '491px';
    card.style.opacity = '1';
  }, 300);
}

// 画面サイズに応じて調整
function adjustForScreenSize() {
  const windowHeight = window.innerHeight;
  const windowWidth = window.innerWidth;
  const carousel = document.querySelector('.carousel');
  
  // 小さい画面向けの調整
  if (windowHeight < 700) {
    const scale = Math.max(0.7, windowHeight / 900);
    carousel.style.transform = `rotateX(0deg) translateY(-30px) scale(${scale})`;
  } else {
    carousel.style.transform = 'rotateX(0deg) translateY(-40px)';
  }
}

// カードカウンターの更新
function updateCardCounter() {
  const counter = document.getElementById('card-counter');
  const count = document.querySelectorAll('.card-wrapper').length;
  counter.textContent = `カード数: ${count} / 現在のインデックス: ${activeCardIndex}`;
}

// カード成長アニメーション
function growCards() {
  const cards = document.querySelectorAll('.card');
  
  // 各カードを順番に成長させる
  cards.forEach((card, i) => {
    setTimeout(() => {
      card.style.height = '491px';
      card.style.opacity = '1';
    }, i * 200);
  });
  
  // アニメーション完了後にスワイプを有効化
  setTimeout(() => {
    isSwipeEnabled = true;
    simulateFloat();
  }, cards.length * 200 + 1000);
}

// カード位置の更新
function updateCardPositions(offsetRatio = 0) {
  const wrappers = document.querySelectorAll('.card-wrapper');
  
  // すべてのクラスをリセット
  wrappers.forEach(wrapper => {
    wrapper.classList.remove('center', 'left', 'right');
  });
  
  wrappers.forEach((wrapper, i) => {
    // 相対位置計算
    let relativePos = i - activeCardIndex - offsetRatio;
    
    // 循環表示の調整
    if (relativePos < -2) relativePos += config.cardCount;
    if (relativePos > 2) relativePos -= config.cardCount;
    
    // X軸位置
    const xPos = relativePos * config.cardSpacing;
    
    // Z軸位置
    const zPos = config.centerZ - Math.abs(relativePos) * 100;
    
    // 回転角度
    const rotationY = relativePos * config.cardRotation;
    
    // 縮小率
    const scale = 1.0 - Math.abs(relativePos) * 0.2;
    
    // 不透明度
    const opacity = 1 - Math.abs(relativePos) * 0.3;
    
    // スタイル適用 - パフォーマンスを考慮して最適化
    wrapper.style.transform = `translateX(${xPos}px) translateZ(${zPos}px) rotateY(${rotationY}deg) scale(${scale})`;
    wrapper.style.opacity = opacity;
    wrapper.style.zIndex = Math.floor(100 - Math.abs(relativePos) * 10);
    
    // 中央カードにクラスを付与
    if (Math.abs(relativePos) < 0.5) {
      wrapper.classList.add('center');
    } else if (relativePos < 0) {
      wrapper.classList.add('left');
    } else {
      wrapper.classList.add('right');
    }
  });
  
  // カードカウンター更新
  updateCardCounter();
  
  // 浮遊アニメーション（スワイプ中でなければ）
  if (!isSwiping) {
    simulateFloat();
  }
}

// 浮遊アニメーション
let floatOffset = 0;
let floatDirection = 1;
function simulateFloat() {
  // 既存のアニメーションをキャンセル
  if (animationFrame) {
    cancelAnimationFrame(animationFrame);
    animationFrame = null;
  }
  
  // 浮遊アニメーション関数
  function animate() {
    try {
      // 中央カードを取得
      const centerCard = document.querySelector('.card-wrapper.center');
      if (!centerCard) return;
      
      floatOffset += 0.05 * floatDirection;
      
      // 方向転換
      if (floatOffset > 5) floatDirection = -1;
      if (floatOffset < -5) floatDirection = 1;
      
      // 現在のtransformを取得
      const currentTransform = centerCard.style.transform;
      if (currentTransform) {
        let transform = currentTransform;
        
        if (transform.includes('translateY(')) {
          transform = transform.replace(/translateY\([^)]+\)/, `translateY(${floatOffset}px)`);
        } else {
          transform += ` translateY(${floatOffset}px)`;
        }
        
        centerCard.style.transform = transform;
      }
      
      // アニメーションの続行（スワイプ中でなければ）
      if (!isSwiping) {
        animationFrame = requestAnimationFrame(animate);
      }
    } catch (err) {
      console.warn('浮遊アニメーションエラー:', err);
    }
  }
  
  // アニメーション開始
  animationFrame = requestAnimationFrame(animate);
}

// スワイプイベントの設定
function setupSwipeEvents() {
  // タッチイベント
  document.addEventListener('touchstart', e => {
    if (!isSwipeEnabled) return;
    if (animationFrame) {
      cancelAnimationFrame(animationFrame);
      animationFrame = null;
    }
    startX = e.touches[0].clientX;
    currentX = startX;
    isSwiping = true;
  }, { passive: true });
  
  document.addEventListener('touchmove', e => {
    if (!isSwipeEnabled || !isSwiping) return;
    currentX = e.touches[0].clientX;
    const diffX = currentX - startX;
    const offsetRatio = diffX / config.swipeSensitivity;
    updateCardPositions(offsetRatio);
  }, { passive: true });
  
  document.addEventListener('touchend', () => {
    if (!isSwipeEnabled || !isSwiping) return;
    finishSwipe();
    isSwiping = false;
    setTimeout(simulateFloat, 100);
  }, { passive: true });
  
  // マウスイベント
  document.addEventListener('mousedown', e => {
    if (!isSwipeEnabled) return;
    if (animationFrame) {
      cancelAnimationFrame(animationFrame);
      animationFrame = null;
    }
    startX = e.clientX;
    currentX = startX;
    isSwiping = true;
  });
  
  document.addEventListener('mousemove', e => {
    if (!isSwipeEnabled || !isSwiping) return;
    currentX = e.clientX;
    const diffX = currentX - startX;
    const offsetRatio = diffX / config.swipeSensitivity;
    updateCardPositions(offsetRatio);
  });
  
  document.addEventListener('mouseup', () => {
    if (!isSwipeEnabled || !isSwiping) return;
    finishSwipe();
    isSwiping = false;
    setTimeout(simulateFloat, 100);
  });
}

// スワイプ終了処理
function finishSwipe() {
  const diffX = currentX - startX;
  const threshold = 50;
  
  if (Math.abs(diffX) < threshold) {
    // 閾値以下ならスワイプなし
    updateCardPositions(0);
    return;
  }
  
  // アクティブカード更新
  if (diffX > 0) {
    // 右スワイプ
    activeCardIndex = (activeCardIndex - 1 + config.cardCount) % config.cardCount;
  } else {
    // 左スワイプ
    activeCardIndex = (activeCardIndex + 1) % config.cardCount;
  }
  
  // 位置更新
  updateCardPositions(0);
}

// リサイズ時の調整
window.addEventListener('resize', function() {
  adjustForScreenSize();
  updateCardPositions();
}, { passive: true });
</script>

</body>
</html>