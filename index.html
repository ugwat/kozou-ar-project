<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>KOZOU+ AR Experience</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=DotGothic16&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      margin: 0; 
      padding: 0;
      width: 100%; 
      height: 100%;
      background-color: #000;
      font-family: 'Press Start 2P', cursive;
      color: #00c8ff;
      position: fixed;
      overflow: hidden;
    }
    
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: black;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: white;
    }
    
    .spinner {
      border: 5px solid rgba(0, 200, 255, 0.1);
      border-top: 5px solid #00c8ff;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    #cards-container {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: 995;
      display: none;
      pointer-events: auto;
    }
    
    .hud-card {
      position: absolute;
      width: 84%;
      height: auto;
      background-color: rgba(0, 20, 40, 0.5);
      border: 2px solid #00c8ff;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 200, 255, 0.5);
      padding: 15px;
      color: white;
      transform-style: preserve-3d;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      top: 40%;
      left: 50%;
    }
    
    .card-title {
      color: #00c8ff;
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
      width: 100%;
    }
    
    .card-content {
      color: #ffffff;
      font-family: 'DotGothic16', sans-serif;
      font-size: 12px;
      text-align: center;
      line-height: 1.5;
      width: 100%;
    }
    
    #ar-container {
      width: 100%;
      height: 100%;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1;
      display: none;
    }
    
    #camera-view {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 10;
    }
    
    #ramen-container {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 20;
      perspective: 1000px;
    }
    
    #ramen-image {
      width: 70%;
      max-width: 300px;
      transform: translateY(0px);
      animation: float 3s ease-in-out infinite;
      filter: drop-shadow(0 10px 15px rgba(0, 200, 255, 0.3));
      margin-top: -20%;
    }
    
    @keyframes float {
      0% { transform: translateY(0px) scale(1); }
      50% { transform: translateY(-10px) scale(1.02); }
      100% { transform: translateY(0px) scale(1); }
    }
    
    .circle-indicator {
      position: absolute;
      bottom: 25px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 1000;
    }
    
    .circle-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: rgba(0, 200, 255, 0.3);
      border: 1px solid rgba(0, 200, 255, 0.8);
      transition: all 0.3s ease;
    }
    
    .circle-dot.active {
      background-color: rgba(0, 200, 255, 0.8);
      transform: scale(1.2);
    }
    
    .swipe-indicator {
      position: absolute;
      top: 50%;
      width: 30px;
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: rgba(0, 200, 255, 0.8);
      font-size: 24px;
      opacity: 0.7;
      z-index: 1000;
      animation: pulse 1.5s infinite ease-in-out;
      pointer-events: none;
    }
    
    .swipe-left {
      left: 20px;
      transform: translateY(-50%);
    }
    
    .swipe-right {
      right: 20px;
      transform: translateY(-50%);
    }
    
    @keyframes pulse {
      0% { opacity: 0.3; transform: translateY(-50%) scale(1); }
      50% { opacity: 0.8; transform: translateY(-50%) scale(1.2); }
      100% { opacity: 0.3; transform: translateY(-50%) scale(1); }
    }
    
    .particle {
      position: absolute;
      background-color: rgba(0, 200, 255, 0.5);
      border-radius: 50%;
      pointer-events: none;
      z-index: 15;
      box-shadow: 0 0 10px rgba(0, 200, 255, 0.5);
      opacity: 0.7;
    }
    
    #hud-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 30;
    }
    
    .hud-element {
      position: absolute;
      border: 1px solid rgba(0, 200, 255, 0.7);
      background-color: rgba(0, 10, 30, 0.2);
      color: #00c8ff;
      font-size: 10px;
      padding: 5px 8px;
      border-radius: 4px;
      pointer-events: none;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .scanner-line {
      position: absolute;
      height: 2px;
      background: linear-gradient(to right, rgba(0, 200, 255, 0), rgba(0, 200, 255, 0.8), rgba(0, 200, 255, 0));
      width: 100%;
      top: 50%;
      animation: scan 3s linear infinite;
      z-index: 25;
    }
    
    @keyframes scan {
      0% { top: 20%; opacity: 0.8; }
      50% { opacity: 0.2; }
      100% { top: 80%; opacity: 0.8; }
    }
    
    #qr-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      height: 200px;
      background-color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 25;
      border-radius: 5px;
    }
    
    #qr-logo {
      position: absolute;
      font-size: 12px;
      font-weight: bold;
      color: #00c8ff;
      text-align: center;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.5);
      padding: 3px 8px;
      border-radius: 3px;
    }
    
    .scan-highlight {
      position: absolute;
      width: 210px;
      height: 210px;
      border: 2px solid #00c8ff;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 15px rgba(0, 200, 255, 0.7);
      animation: highlight-pulse 2s infinite ease-in-out;
      z-index: 24;
      border-radius: 8px;
    }
    
    @keyframes highlight-pulse {
      0% { box-shadow: 0 0 15px rgba(0, 200, 255, 0.7); }
      50% { box-shadow: 0 0 25px rgba(0, 200, 255, 1); }
      100% { box-shadow: 0 0 15px rgba(0, 200, 255, 0.7); }
    }
    
    .corner-bracket {
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid #00c8ff;
      z-index: 26;
    }
    
    .top-left {
      top: 50%;
      left: 50%;
      transform: translate(calc(-50% - 95px), calc(-50% - 95px));
      border-right: none;
      border-bottom: none;
    }
    
    .top-right {
      top: 50%;
      right: 50%;
      transform: translate(calc(50% + 95px), calc(-50% - 95px));
      border-left: none;
      border-bottom: none;
    }
    
    .bottom-left {
      bottom: 50%;
      left: 50%;
      transform: translate(calc(-50% - 95px), calc(50% + 95px));
      border-right: none;
      border-top: none;
    }
    
    .bottom-right {
      bottom: 50%;
      right: 50%;
      transform: translate(calc(50% + 95px), calc(50% + 95px));
      border-left: none;
      border-top: none;
    }
  </style>
</head>
<body>
  <div id="loading-screen">
    <div class="spinner"></div>
    <div>読み込み中...</div>
  </div>
  
  <div id="cards-container">
    <!-- カードはJavaScriptで動的に生成されます -->
  </div>

  <div id="ar-container">
    <!-- カメラビュー -->
    <video id="camera-view" autoplay playsinline></video>
    
    <!-- QRコード -->
    <div id="qr-container">
      <div id="qr-logo">KOZOU+</div>
      <!-- QRコード画像 -->
      <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=https://kozou-plus.jp" alt="KOZOU+ QR Code">
    </div>
    
    <!-- スキャンハイライト -->
    <div class="scan-highlight"></div>
    <div class="corner-bracket top-left"></div>
    <div class="corner-bracket top-right"></div>
    <div class="corner-bracket bottom-left"></div>
    <div class="corner-bracket bottom-right"></div>
    
    <!-- ラーメン画像コンテナ -->
    <div id="ramen-container">
      <img id="ramen-image" src="ramen_3d.png" alt="KOZOU+ まぜそば" style="display:none;">
    </div>
    
    <!-- スキャンライン効果 -->
    <div class="scanner-line"></div>
    
    <!-- HUDオーバーレイ -->
    <div id="hud-overlay"></div>
    
    <!-- スワイプインジケーター -->
    <div class="swipe-indicator swipe-left">←</div>
    <div class="swipe-indicator swipe-right">→</div>
    
    <!-- ステップインジケーター -->
    <div class="circle-indicator">
      <!-- JavaScriptでドットが生成されます -->
    </div>
  </div>

  <script>
    // グローバル変数
    let activeCardIndex = 0;
    let startX = 0;
    let currentX = 0;
    let isSwiping = false;
    let scanComplete = false;
    
    // ステップデータ
    const stepsData = [
      {
        title: "STEP 1: 混ぜる前の状態",
        content: "まずは美しく盛り付けられたまぜそばの状態を確認しましょう。トッピングの配置を覚えておくと良いでしょう。"
      },
      {
        title: "STEP 2: よく混ぜる",
        content: "箸を使って、底から全体をしっかりと混ぜます。タレと具材が均一になるまで混ぜるのがポイントです。"
      },
      {
        title: "STEP 3: 最初の一口",
        content: "よく混ぜたら、まずは麺とタレの味わいを楽しみましょう。香りと旨味が口いっぱいに広がります。"
      },
      {
        title: "STEP 4: 追いニンニク",
        content: "途中で用意されたニンニクを加えると、また違った味わいを楽しめます。好みに合わせて調整しましょう。"
      }
    ];
    
    // DOMの読み込み完了時の処理
    document.addEventListener("DOMContentLoaded", function() {
      console.log("DOM読み込み完了");
      
      // 読み込み画面を表示
      const loadingScreen = document.getElementById('loading-screen');
      
      // ボタンを追加してユーザーが明示的にARを開始できるようにする
      const startButton = document.createElement('button');
      startButton.textContent = 'AR体験を開始';
      startButton.style.padding = '15px 30px';
      startButton.style.backgroundColor = '#00a2ff';
      startButton.style.color = 'white';
      startButton.style.border = 'none';
      startButton.style.borderRadius = '5px';
      startButton.style.fontSize = '18px';
      startButton.style.cursor = 'pointer';
      startButton.style.boxShadow = '0 0 15px rgba(0, 200, 255, 0.5)';
      
      loadingScreen.appendChild(startButton);
      
      // ボタンクリックでARを開始
      startButton.addEventListener('click', () => {
        loadingScreen.style.display = 'none';
        initAR();
      });
    });

    // ARの初期化
    function initAR() {
      console.log("AR初期化開始");
      
      // ARコンテナ
      const arContainer = document.getElementById('ar-container');
      arContainer.style.display = 'block';
      
      // カメラビュー
      const cameraView = document.getElementById('camera-view');
      
      // カメラアクセス
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(function(stream) {
          cameraView.srcObject = stream;
          // カメラが起動したらUIを初期化
          setTimeout(() => {
            initializeUI();
            createHUDElements();
            createParticles();
            
            // スキャン完了シミュレーション
            setTimeout(() => {
              simulateScanComplete();
            }, 3000);
          }, 1000);
        })
        .catch(function(err) {
          console.error("カメラエラー: ", err);
          alert("カメラへのアクセスが拒否されました");
        });
      
      // スワイプイベント
      setupSwipeEvents();
    }
    
    // スキャン完了をシミュレート
    function simulateScanComplete() {
      scanComplete = true;
      
      // QRコンテナを非表示
      const qrContainer = document.getElementById('qr-container');
      const scanHighlight = document.querySelector('.scan-highlight');
      const cornerBrackets = document.querySelectorAll('.corner-bracket');
      
      // フェードアウトアニメーション
      qrContainer.style.transition = 'opacity 0.5s ease-out';
      qrContainer.style.opacity = '0';
      scanHighlight.style.transition = 'opacity 0.5s ease-out';
      scanHighlight.style.opacity = '0';
      
      cornerBrackets.forEach(bracket => {
        bracket.style.transition = 'opacity 0.5s ease-out';
        bracket.style.opacity = '0';
      });
      
      // HUDの更新
      updateHUDForScanComplete();
      
      // ラーメン画像を表示
      setTimeout(() => {
        const ramenImage = document.getElementById('ramen-image');
        ramenImage.style.display = 'block';
        
        // QR要素を削除
        setTimeout(() => {
          if (qrContainer.parentNode) {
            qrContainer.parentNode.removeChild(qrContainer);
          }
          if (scanHighlight.parentNode) {
            scanHighlight.parentNode.removeChild(scanHighlight);
          }
          cornerBrackets.forEach(bracket => {
            if (bracket.parentNode) {
              bracket.parentNode.removeChild(bracket);
            }
          });
        }, 500);
      }, 500);
    }
    
    // スキャン完了後のHUD更新
    function updateHUDForScanComplete() {
      const scanCompleteElement = document.querySelector('.hud-element.scan-complete');
      if (scanCompleteElement) {
        scanCompleteElement.style.color = '#00ff00';
        scanCompleteElement.style.borderColor = '#00ff00';
        scanCompleteElement.style.animation = 'pulse 1.5s ease-in-out';
      }
      
      const analyzingElement = document.querySelector('.hud-element.analyzing');
      if (analyzingElement) {
        analyzingElement.style.animation = 'pulse 1.5s infinite ease-in-out';
      }
    }
    
    // UIの初期化
    function initializeUI() {
      // カードを作成
      createCards();
      
      // インジケーターを追加
      addStepIndicators();
      
      // 最初のカードをアクティブに
      updateCardPosition();
    }
    
    // カードを作成
    function createCards() {
      const cardsContainer = document.getElementById('cards-container');
      cardsContainer.innerHTML = '';
      cardsContainer.style.display = 'block';
      
      stepsData.forEach((step, index) => {
        const card = document.createElement('div');
        card.className = 'hud-card';
        card.id = `card-${index}`;
        
        // 初期位置と表示状態
        card.style.opacity = index === activeCardIndex ? '1' : '0';
        card.style.transform = getCardTransform(index);
        card.style.zIndex = 1000 - Math.abs(index - activeCardIndex);
        
        // コンテンツ
        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = step.title;
        
        const content = document.createElement('div');
        content.className = 'card-content';
        content.textContent = step.content;
        
        card.appendChild(title);
        card.appendChild(content);
        cardsContainer.appendChild(card);
      });
    }
    
    // カードの位置を計算
    function getCardTransform(index) {
      const diff = index - activeCardIndex;
      
      if (diff === 0) {
        // アクティブカード
        return 'translate(-50%, -50%) scale(1)';
      } else if (diff > 0) {
        // 右側のカード
        return `translate(calc(-50% + ${100 + diff * 20}%), -50%) scale(0.8) rotateY(-10deg)`;
      } else {
        // 左側のカード
        return `translate(calc(-50% - ${100 + Math.abs(diff) * 20}%), -50%) scale(0.8) rotateY(10deg)`;
      }
    }
    
    // スワイプイベントのセットアップ
    function setupSwipeEvents() {
      // タッチイベント
      document.addEventListener('touchstart', handleTouchStart, false);
      document.addEventListener('touchmove', handleTouchMove, false);
      document.addEventListener('touchend', handleTouchEnd, false);
      
      // マウスイベント（デスクトップ用）
      document.addEventListener('mousedown', handleMouseDown, false);
      document.addEventListener('mousemove', handleMouseMove, false);
      document.addEventListener('mouseup', handleMouseUp, false);
    }
    
    // タッチイベントハンドラー
    function handleTouchStart(event) {
      startX = event.touches[0].clientX;
      isSwiping = true;
    }
    
    function handleTouchMove(event) {
      if (!isSwiping) return;
      
      currentX = event.touches[0].clientX;
      const diffX = currentX - startX;
      
      // スワイプ中の視覚効果
      updateSwipingEffect(diffX);
    }
    
    function handleTouchEnd(event) {
      if (!isSwiping) return;
      
      const diffX = currentX - startX;
      finishSwipe(diffX);
      
      isSwiping = false;
    }
    
    // マウスイベントハンドラー
    function handleMouseDown(event) {
      startX = event.clientX;
      isSwiping = true;
    }
    
    function handleMouseMove(event) {
      if (!isSwiping) return;
      
      currentX = event.clientX;
      const diffX = currentX - startX;
      
      // スワイプ中の視覚効果
      updateSwipingEffect(diffX);
    }
    
    function handleMouseUp(event) {
      if (!isSwiping) return;
      
      const diffX = currentX - startX;
      finishSwipe(diffX);
      
      isSwiping = false;
    }
    
    // スワイプ中の視覚効果
    function updateSwipingEffect(diffX) {
      if (!scanComplete) return;
      
      // 少し動かす効果
      const ramenImage = document.getElementById('ramen-image');
      if (ramenImage && ramenImage.style.display !== 'none') {
        ramenImage.style.transform = `translateX(${diffX * 0.1}px) translateY(0px)`;
      }
      
      // カード移動の予備動作
      const cards = document.querySelectorAll('.hud-card');
      cards.forEach((card, index) => {
        const baseTransform = getCardTransform(index);
        const translateX = diffX * 0.3;
        card.style.transform = baseTransform.replace('translate', `translateX(${translateX}px) translate`);
      });
    }
    
    // スワイプ完了時の処理
    function finishSwipe(diffX) {
      if (!scanComplete) return;
      
      // スワイプの閾値
      const threshold = window.innerWidth * 0.15;
      
      if (diffX > threshold && activeCardIndex > 0) {
        // 右スワイプ：前のカード
        activeCardIndex--;
        addSwipeParticles('right');
      } else if (diffX < -threshold && activeCardIndex < stepsData.length - 1) {
        // 左スワイプ：次のカード
        activeCardIndex++;
        addSwipeParticles('left');
      }
      
      // カードの位置を更新
      updateCardPosition();
      
      // ラーメン画像を元の位置に戻す
      const ramenImage = document.getElementById('ramen-image');
      if (ramenImage) {
        ramenImage.style.transform = '';
      }
      
      // インジケーター更新
      updateStepIndicators();
    }
    
    // カードの位置を更新
    function updateCardPosition() {
      const cards = document.querySelectorAll('.hud-card');
      
      cards.forEach((card, index) => {
        const diff = index - activeCardIndex;
        
        // カードのスタイルを更新
        card.style.opacity = diff === 0 ? '1' : (Math.abs(diff) <= 1 ? '0.5' : '0');
        card.style.transform = getCardTransform(index);
        card.style.zIndex = 1000 - Math.abs(diff);
        
        // 表示範囲外のカードは非表示
        card.style.display = Math.abs(diff) <= 2 ? 'flex' : 'none';
      });
      
      // スワイプインジケーターの表示/非表示
      updateSwipeIndicators();
    }
    
    // スワイプインジケーターの更新
    function updateSwipeIndicators() {
      const leftIndicator = document.querySelector('.swipe-left');
      const rightIndicator = document.querySelector('.swipe-right');
      
      leftIndicator.style.display = activeCardIndex > 0 ? 'flex' : 'none';
      rightIndicator.style.display = activeCardIndex < stepsData.length - 1 ? 'flex' : 'none';
    }
    
    // ステップインジケーターを追加
    function addStepIndicators() {
      const indicatorContainer = document.querySelector('.circle-indicator');
      indicatorContainer.innerHTML = '';
      
      stepsData.forEach((step, index) => {
        const dot = document.createElement('div');
        dot.className = 'circle-dot';
        if (index === activeCardIndex) {
          dot.classList.add('active');
        }
        
        indicatorContainer.appendChild(dot);
      });
    }
    
    // ステップインジケーターを更新
    function updateStepIndicators() {
      const dots = document.querySelectorAll('.circle-dot');
      
      dots.forEach((dot, index) => {
        if (index === activeCardIndex) {
          dot.classList.add('active');
        } else {
          dot.classList.remove('active');
        }
      });
      
      // ステップインジケーター更新
      const stepIndicator = document.getElementById('step-indicator');
      if (stepIndicator) {
        stepIndicator.textContent = `STEP ${activeCardIndex + 1}/4`;
      }
    }
    
    // HUD要素を作成
    function createHUDElements() {
      const hudOverlay = document.getElementById('hud-overlay');
      
      // HUD要素
      const hudElements = [
        { top: '20px', left: '20px', text: 'KOZOU+ AR SYSTEM v1.0' },
        { top: '20px', right: '20px', text: 'STEP 1/4', id: 'step-indicator' },
        { bottom: '70px', left: '20px', text: 'SCAN COMPLETE', class: 'scan-complete' },
        { bottom: '70px', right: '20px', text: 'ANALYZING...', class: 'analyzing' }
      ];
      
      hudElements.forEach(pos => {
        const elem = document.createElement('div');
        elem.className = 'hud-element';
        if (pos.id) {
          elem.id = pos.id;
        }
        if (pos.class) {
          elem.classList.add(pos.class);
        }
        
        // 位置設定
        Object.keys(pos).forEach(key => {
          if (key !== 'text' && key !== 'id' && key !== 'class') {
            elem.style[key] = pos[key];
          }
        });
        
        elem.textContent = pos.text;
        hudOverlay.appendChild(elem);
      });
    }
    
    // 粒子を作成
    function createParticles() {
      const arContainer = document.getElementById('ar-container');
      
      for (let i = 0; i < 20; i++) {
        createParticle(arContainer);
      }
    }
    
    // 個別の粒子を作成
    function createParticle(container) {
      const particle =