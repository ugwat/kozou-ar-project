<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>KOZOU+ AR Experience</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { 
    width: 100%; 
    height: 100vh;
    background: #000; 
    overflow: hidden; 
  }
  #ar-container { 
    width: 100%; 
    height: 100%; 
    position: fixed; 
    top: 0; 
    left: 0; 
    z-index: 1; 
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    text-align: center;
  }
  #camera-view { position: absolute; width: 100%; height: 100%; object-fit: cover; z-index: 10; background: #000; }
  .scene { position: absolute; width: 100%; height: 100%; transform-style: preserve-3d; perspective: 1400px; z-index: 20; }
  .carousel { 
    position: absolute; 
    width: 100%; 
    height: 100%; 
    transform-style: preserve-3d; 
    transform: translateY(-80px) rotateX(20deg);
  }
  
  /* カードスタイルはそのまま保持（省略） */
  
  /* カメラ許可ボタン */
  #camera-permission-button {
    padding: 15px 30px;
    background: #00a2ff;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 18px;
    cursor: pointer;
    margin-top: 20px;
  }
  
  /* ローディングアニメーション */
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  #loading-indicator {
    border: 5px solid rgba(0,200,255,0.1);
    border-top: 5px solid #00c8ff;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
  }

  /* 以下、既存のスタイルをそのまま保持（省略） */
</style>
<script>
// ShowOneChildエラーの強化対策
try {
  window.ShowOneChild = window.ShowOneChild || {
    readRenderPromptFromStorage: function() { return null; },
    getRenderPrompt: function() { return null; },
    render: function() { return null; }
  };
  
  // localStorage拡張 - エラーが出ないように修正
  window.localStorage = window.localStorage || {};
  window.localStorage.getWithTTL = window.localStorage.getWithTTL || function(key) {
    return null;
  };
} catch (e) {
  console.warn("初期化スクリプトエラー:", e);
}

// エラー抑制コード（そのまま保持）
</script>
</head>

<body>
<!-- エラー抑制用のダミー要素 -->
<div id="error-suppression-container">
  <div id="ShowOneChild-dummy"></div>
</div>

<div id="ar-container">
  <div id="loading-indicator"></div>
  <div>AR体験を開始するには、カメラへのアクセスを許可してください</div>
  <button id="camera-permission-button">カメラにアクセス</button>
  
  <video id="camera-view" autoplay playsinline muted style="display:none;"></video>
  <div class="overlay" style="display:none;"></div>
  <div class="scene" style="display:none;">
    <div class="carousel"></div>
  </div>
</div>

<!-- フォトフレーム画面（そのまま保持） -->

<!-- 説明ポップアップ（そのまま保持） -->

<script>
// 既存のJavaScriptコードから必要な部分だけを保持

document.addEventListener("DOMContentLoaded", function() {
  // カメラボタンクリック時にカメラ起動
  document.getElementById('camera-permission-button').addEventListener('click', function() {
    this.style.display = 'none';
    document.getElementById('loading-indicator').style.display = 'block';
    
    // カメラアクセス開始
    initAR();
  });
  
  // その他のイベントリスナー（そのまま保持）
});

function initAR() {
  try {
    // カメラアクセス
    navigator.mediaDevices.getUserMedia({ 
      video: { 
        facingMode: 'environment',
        width: { ideal: window.innerWidth },
        height: { ideal: window.innerHeight }
      } 
    })
    .then(function(stream) {
      const cameraView = document.getElementById('camera-view');
      cameraView.srcObject = stream;
      cameraView.onloadedmetadata = function() {
        try {
          cameraView.play()
            .then(function() {
              // カメラ起動成功後、UIを表示
              document.getElementById('loading-indicator').style.display = 'none';
              document.getElementById('camera-view').style.display = 'block';
              document.querySelector('.overlay').style.display = 'block';
              document.querySelector('.scene').style.display = 'block';
              
              // カード作成
              createCards();
            })
            .catch(function(error) {
              console.warn("ビデオ再生エラー:", error);
              alert("カメラの起動に失敗しました。デバイスの設定を確認してください。");
            });
        } catch(e) {
          console.warn("ビデオ再生例外:", e);
          alert("カメラの起動に失敗しました。デバイスの設定を確認してください。");
        }
      };
    })
    .catch(function(error) {
      console.warn("カメラエラー:", error);
      alert("カメラへのアクセスが拒否されました。AR体験には、カメラの許可が必要です。");
    });
  } catch (e) {
    console.warn("MediaDevices API エラー:", e);
    alert("お使いのデバイスではカメラにアクセスできません。");
  }
}

// 以下、既存の関数をそのまま保持（createCards, growCards, updateCardPositions など）
</script>

</body>
</html>